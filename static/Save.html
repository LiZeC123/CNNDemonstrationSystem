<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <title></title>
        <link rel="stylesheet" type="text/css" media="screen" href="main.css">
        <script src="js/jquery-1.7.2.min.js"></script>
        <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.9.24/paper-full.min.js"></script>
        <script src="js/imageTools.js"></script>
        <script type="text/javascript">
            let ctx;
            //按下标记
            let onOff = false;
            let oldX = -10;
            let oldY = -10;
            
            //鼠标弹起取消绘制
            function up() {
                onOff = false;
            }

            //获取鼠标坐标，并根据坐标绘制图像
            function draw(event) {
                if (onOff === true) {
                    const newX = event.pageX - 10;
                    const newY = event.pageY - 10;

                    ctx.beginPath();
                    ctx.moveTo(oldX, oldY);
                    ctx.lineTo(newX, newY);
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 4;
                    ctx.lineCap = 'round';
                    ctx.stroke();

                    oldX = newX;
                    oldY = newY;
                }
            }
            
            function clean() {
                const c = document.getElementById('canvas');
                ctx = c.getContext('2d');

                //画一个黑色矩形
                ctx.fillStyle = 'black';
                ctx.fillRect(0, 0, 600, 300);
            }

            //转canvas保存为base64 dataURL
            function copyImage(event) {
                const img_png_src = canvas.toDataURL('image/png');
                document.getElementById('image_png').src = img_png_src;
                $.post('http://127.0.0.1:5000/recognition',{"image":img_png_src},function (jsonStr) {
                    $("#result").html(jsonStr);
                    rdata = JSON.parse(jsonStr);
                    drawNerve(rdata.data);
                    $("#numberResult").html(rdata.predict);
                })
            }

            //鼠标按下获取坐标
            function down(event) {
                onOff = true;
                oldX = event.pageX - 10;
                oldY = event.pageY - 10;
            }

            $(function () {
                const c = document.getElementById('canvas');
                ctx = c.getContext('2d');

                //画一个黑色矩形
                ctx.fillStyle = 'black';
                ctx.fillRect(0, 0, 600, 300);

                //添加鼠标移动事件
                canvas.addEventListener('mousemove', draw, true);

                //添加鼠标按下事件
                canvas.addEventListener('mousedown', down, false);

                //添加鼠标弹起事件
                canvas.addEventListener('mouseup', up, false);
            })

        </script>
    </head>

    <body>
        <canvas id="canvas" width="112" height="112"></canvas>
        <button id="btnExport" style="width:80px;background-color:pink; " onclick="copyImage(); ">导出</button>
        <button id="btnClear" style="width:80px;background-color:yellow; " onclick="clean();">清除</button>
        <p>识别结果是
        <div id="numberResult"></div>
        </p>

        <img src="" id="image_png" width="224" height="224" style="display: none" alt="">
        <canvas id="mainCanvas"></canvas>
        <p>Result is</p><p id="result"></p>
    </body>

</html>

